<div dir=”rtl”>
  
# تست نفوذ داکر

---

## ۱. داکر چیست؟

داکر (Docker) یک پلتفرم اوپن سورس برای توسعه، ارسال و اجرای نرم‌افزارها در کانتینرهاست. کانتینرها بسته‌های سبکی از نرم‌افزارها هستند که شامل تمام وابستگی‌های نرم‌افزاری، کتابخانه‌ها و تنظیمات مورد نیاز برای اجرای نرم‌افزار در هر سیستمی می‌باشند. این روش باعث می‌شود که نرم‌افزارها بدون نگرانی از وابستگی‌ها یا تفاوت‌های محیط‌های مختلف، به صورت یکپارچه اجرا شوند.

### مزایای داکر:

- **قابلیت حمل بالا**: کانتینرها روی هر سیستمی که Docker نصب باشد اجرا می‌شوند.
- **ایزوله‌سازی**: برنامه‌ها در کانتینرهای جداگانه اجرا می‌شوند و از همدیگر ایزوله هستند.
- **سبکی**: کانتینرها بر خلاف ماشین‌های مجازی نیازی به کرنل مجزا ندارند، بنابراین سبک‌تر و سریع‌تر هستند.
- **توسعه سریع‌تر**: توسعه‌دهندگان می‌توانند برنامه‌ها را در محیط‌های ایزوله تست و اجرا کنند.

---

## ۲. نصب داکر

### مراحل نصب داکر در لینوکس (توزیع اوبونتو به عنوان نمونه):

**به‌روزرسانی پکیج‌ها**:
  
    
    sudo apt update
    
    
**نصب پیش‌نیازها**:
    
    
    sudo apt install apt-transport-https ca-certificates curl software-properties-common
    
    
**اضافه کردن کلید GPG رسمی داکر**:
    
    
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
   
    
**اضافه کردن مخزن Docker به منابع سیستمی**:
    
    
    echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    
    
**نصب داکر**:
    
    
    sudo apt update
    sudo apt install docker-ce
    
    
**تست نصب داکر**:
برای اطمینان از موفقیت‌آمیز بودن نصب، می‌توانید یک کانتینر ساده اجرا کنید:
    
    
    sudo docker run hello-world
    
    

### نصب Docker در ویندوز:

**دانلود Docker Desktop**: به وبسایت رسمی Docker رفته و Docker Desktop را برای ویندوز دانلود کنید.
**نصب و تنظیمات اولیه**: پس از نصب، می‌توانید با کلیک روی آیکون Docker Desktop آن را باز کنید و مطمئن شوید که داکر به درستی در حال اجراست.
**تست نصب**: مشابه لینوکس، دستور زیر را در PowerShell اجرا کنید:
    
    
    docker run hello-world
    
    

---

## ۳. آسیب‌پذیری‌های داکر

داکر به عنوان یک ابزار مهم در توسعه نرم‌افزار، گاهی می‌تواند در معرض آسیب‌پذیری‌های امنیتی قرار بگیرد. در ادامه به برخی از این آسیب‌پذیری‌ها و مشکلاتی که ممکن است وجود داشته باشد، اشاره می‌شود:

### ۱. **اجرای کد مخرب**:

اگر یک کانتینر یا تصویر داکر از منبع ناشناخته‌ای دریافت شود، ممکن است شامل کد مخربی باشد که می‌تواند به سیستم اصلی دسترسی پیدا کند.

### ۲. **استفاده از image غیرامن**:

استفاده از image داکر بدون بررسی امنیتی یا به‌روزرسانی آنها ممکن است منجر به اجرای کدهای آسیب‌پذیر شود.

### ۳. **امتداد دسترسی‌ها (Privilege Escalation)**:

کانتینرهایی که با دسترسی روت اجرا می‌شوند می‌توانند در صورت آسیب‌پذیری به دسترسی‌های ریشه‌ای سیستم اصلی دسترسی پیدا کنند.

### ۴. **نقص در ایزوله‌سازی**:

در صورت استفاده نادرست از پیکربندی‌های امنیتی داکر، ممکن است ایزوله‌سازی بین کانتینرها شکسته شده و یکی از کانتینرها به دیگری یا حتی به سیستم اصلی دسترسی پیدا کند.

---

## ۴. چک‌لیست بررسی آسیب‌پذیری‌های داکر برای تست نفوذ

برای اطمینان از امنیت کانتینرهای داکر، می‌توان به نکات زیر توجه کرد:

### ۱. **بررسی image داکر**:

- از image رسمی و به‌روز استفاده کنید.
- با استفاده از ابزارهایی مانند **Trivy** برای یافتن آسیب‌پذیری‌ها اسکن کنید:
`bash trivy image <image_name>`

### ۲. **محدود کردن دسترسی‌ها**:

- کانتینرها را با دسترسی‌های کمینه اجرا کنید (بدون روت).
- از قابلیت‌های **Linux Capabilities** برای محدود کردن مجوزها استفاده کنید:
`bash docker run --cap-drop=ALL --cap-add=NET_BIND_SERVICE <image_name>`

### ۳. **استفاده از شبکه‌های امن**:

- از شبکه‌های خصوصی داکر برای ارتباطات بین کانتینرها استفاده کنید.
- تنظیمات فایروال و قوانین دسترسی شبکه را به دقت بررسی کنید.

### ۴. **استفاده از AppArmor یا SELinux**:

- از ابزارهای امنیتی مانند **AppArmor** یا **SELinux** برای محدود کردن دسترسی‌های کانتینرها به سیستم اصلی استفاده کنید.

### ۵. **به‌روزرسانی مداوم**:

- داکر و تمامی image کانتینری را به طور مرتب به‌روز کنید.

### ۶. **ثبت لاگ‌ها و مانیتورینگ**:

- لاگ‌های داکر و فعالیت‌های کانتینرها را برای رفتارهای غیرمعمول مانیتور کنید.

### ۷. **بررسی پیکربندی‌های داکر**:

- فایل‌های پیکربندی داکر را بررسی کنید تا مطمئن شوید هیچ تنظیمات ناامن یا آسیب‌پذیری در آنها وجود ندارد.

---

## مجموعه تست: تست نفوذ امنیتی داکر

### پیش‌نیازها:

- دسترسی به میزبان داکر (دسترسی CLI برای انجام پیکربندی‌ها و اجرای اسکن‌های امنیتی).
- موتور داکر و کانتینرها در حال اجرا باشند.
- ابزارهای تست نفوذ مانند nmap، Clair، Docker Bench for Security و دیگر ابزارهای نصب‌شده بر روی ماشین تست.

## مورد تست #۱: اعتبارسنجی نسخه و پیکربندی داکر

هدف: اطمینان از به‌روز بودن داکر و پیکربندی ایمن آن.

| مرحله تست | توضیحات | نتیجه مورد انتظار | ابزارها |
| --- | --- | --- | --- |
| بررسی نسخه داکر | اجرای `docker version` برای تأیید اینکه نسخه داکر به‌روز است. | داکر باید آخرین نسخه پایدار را اجرا کند. | `docker version` |
| بررسی اطلاعات اجرای داکر | اجرای `docker info` برای بازبینی درایور ذخیره‌سازی، گزینه‌های اجرای داکر و نسخه کرنل. | درایور ذخیره‌سازی مناسب (مثلاً `overlay2`)، نسخه پشتیبانی‌شده کرنل و گزینه‌های حداقلی فعال باشند. | `docker info` |
| بازبینی پیکربندی دیمون داکر | بررسی فایل `daemon.json` یا گزینه‌های اجرای دیمون داکر برای پارامترهای مربوط به امنیت (مانند `userns-remap`، `no-new-privileges`). | بهترین شیوه‌ها رعایت شده باشد (مانند فعال بودن فضای نام‌های کاربری، وجود پروفایل‌های seccomp). | بررسی دستی فایل `daemon.json` |

## مورد تست #۲: بررسی کانتینرهای با دسترسی بالا

هدف: اطمینان از اینکه کانتینرها با مجوزهای اضافی اجرا نمی‌شوند.

| مرحله تست | توضیحات | نتیجه مورد انتظار | ابزارها |
| --- | --- | --- | --- |
| فهرست کردن کانتینرهای در حال اجرا | اجرای `docker ps` برای شناسایی کانتینرهای در حال اجرا. | فهرست کانتینرهای فعال. | `docker ps` |
| بررسی کانتینرهای با دسترسی بالا | استفاده از `docker inspect <container_id>` برای بررسی اینکه آیا کانتینرها در حالت دسترسی بالا اجرا می‌شوند یا خیر. | هیچ کانتینری نباید با `privileged=true` اجرا شود. | `docker inspect --format '{{.HostConfig.Privileged}}' <container_id>` |
| بررسی محدودیت‌های قابلیت کانتینر | استفاده از `docker inspect` برای تأیید قابلیت‌های کانتینر (مانند `NET_ADMIN`، `SYS_ADMIN`). | فقط قابلیت‌های حداقلی مورد نیاز باید اعطا شوند. | `docker inspect` |

## مورد تست #۳: امنیت شبکه کانتینر

هدف: اطمینان از ایزوله بودن مناسب شبکه بین کانتینرها و میزبان.

| مرحله تست | توضیحات | نتیجه مورد انتظار | ابزارها |
| --- | --- | --- | --- |
| فهرست کردن پورت‌های باز | انجام اسکن پورت بر روی کانتینرهای داکر و میزبان با استفاده از `nmap`. | فقط پورت‌های مورد نیاز باید باز باشند. | `nmap`, `docker ps --format '{{.Ports}}'` |
| بررسی وضعیت شبکه | بازرسی وضعیت شبکه کانتینرها (مانند bridge، host) برای تأیید ایزوله بودن. | کانتینرها باید از ایزوله بودن شبکه (مانند حالت `bridge`) استفاده کنند. از استفاده از حالت `host` مگر در صورت ضرورت خودداری کنید. | `docker inspect --format '{{.HostConfig.NetworkMode}}' <container_id>` |
| بررسی تنظیمات فایروال | اطمینان از اینکه قوانین فایروال در میزبان داکر برای اجازه/ممنوع کردن دسترسی کانتینر به درستی پیکربندی شده‌اند. | قوانین فایروال باید ترافیک کانتینر را مطابق با سیاست محدود کنند. | `iptables`, `ufw`, `firewalld` |

## مورد تست #۴: بررسی امتیازات کاربری داکر

هدف: اطمینان از اینکه کانتینرهای داکر به‌جز در صورت ضرورت با دسترسی روت اجرا نمی‌شوند.

| مرحله تست | توضیحات | نتیجه مورد انتظار | ابزارها |
| --- | --- | --- | --- |
| بررسی کاربر اجرای کانتینرها | اجرای `docker inspect --format '{{.Config.User}}' <container_id>` برای بررسی زمینه کاربری. | کانتینرها نباید به عنوان `root` اجرا شوند مگر در صورت ضرورت صریح. | `docker inspect` |
| بررسی فضای نام‌های کاربری | اطمینان از فعال بودن `userns-remap` برای ایزوله کردن فضای کاربری کانتینر از میزبان. | `userns-remap` باید فعال باشد. | بررسی `daemon.json` یا `docker info` |

## مورد تست #۵: اسکن آسیب‌پذیری‌های image داکر

هدف: شناسایی هرگونه آسیب‌پذیری در image داکر.

| مرحله تست | توضیحات | نتیجه مورد انتظار | ابزارها |
| --- | --- | --- | --- |
| اسکن image برای آسیب‌پذیری‌ها | استفاده از Clair، Trivy یا Aqua Microscanner برای اسکن image پایه. | نباید آسیب‌پذیری‌های بحرانی در image داکر وجود داشته باشد. | `Clair`, `Trivy`, `Aqua Microscanner` |
| اطمینان از اینکه image از منابع معتبر هستند | بررسی Dockerfiles و image استفاده شده برای تأیید اینکه از رجیستری‌ها و منابع معتبر آمده‌اند. | تنها image معتبر از رجیستری‌های امن باید استفاده شوند. | بررسی Dockerfiles و تنظیمات رجیستری |

## مورد تست #۶: پیکربندی نادرست حجم‌های داکر

هدف: اطمینان از اینکه دایرکتوری‌های حساس میزبان به کانتینرها افشا نشده‌اند.

| مرحله تست | توضیحات | نتیجه مورد انتظار | ابزارها |
| --- | --- | --- | --- |
| بررسی نقاط Mount | اجرای `docker inspect` برای بررسی نقاط Mount. توجه ویژه به نقاطی مانند /var/run/docker.sock. | دایرکتوری‌های حساس نباید به کانتینرها متصل شوند. | `docker inspect --format '{{.Mounts}}' <container_id>` |
| بررسی دسترسی به حجم‌های متصل شده | دسترسی به شل کانتینر و تلاش برای تعامل با دایرکتوری‌های حساس (اگر متصل شده باشند). | دایرکتوری‌های حساس باید درون کانتینرها غیرقابل دسترسی باشند. | `docker exec -it <container_id> /bin/sh` |

## مورد تست #۷: امنیت دیمون داکر

هدف: اطمینان از اینکه دیمون داکر به صورت ایمن پیکربندی شده است.

| مرحله تست | توضیحات | نتیجه مورد انتظار | ابزارها |
| --- | --- | --- | --- |
| اجرای Docker Bench for Security | استفاده از Docker Bench for Security برای انجام ممیزی امنیتی تنظیمات دیمون داکر. | دیمون داکر باید با بهترین شیوه‌های CIS Docker benchmark مطابقت داشته باشد. | `Docker Bench for Security` |
| بررسی پیکربندی TLS دیمون | اطمینان از اینکه ارتباطات دیمون داکر با TLS برای امنیت ارتباطات مشتریان استفاده می‌شود. | TLS باید فعال و به درستی پیکربندی شده باشد. | بررسی `daemon.json` یا استفاده از `docker info` |
| بررسی دسترسی به API از راه دور | اطمینان از اینکه API داکر به دسترسی خارجی افشا نشده است مگر در صورت ضرورت صریح. | API داکر نباید به طور عمومی افشا شده باشد مگر در صورت ضرورت، و باید با TLS محافظت شود. | `netstat`, `curl` |

## مورد تست #۸: محافظت در برابر خروج از کانتینر

هدف: اطمینان از اینکه کانتینرها ایزوله شده و نمی‌توانند به میزبان فرار کنند.

| مرحله تست | توضیحات | نتیجه مورد انتظار | ابزارها |
| --- | --- | --- | --- |
| تست روش‌های خروج از کانتینر | انجام تست‌هایی مانند اتصال به سیستم فایل میزبان، بهره‌برداری از آسیب‌پذیری‌های شناخته شده (مانند Dirty COW) برای خروج از کانتینر. | کانتینرها نباید قادر به فرار به سیستم میزبان باشند. | تست‌های دستی، اسکریپت‌های خروج از کانتینر |
| بررسی پروفایل‌های seccomp و AppArmor | بررسی اینکه آیا کانتینرها از پروفایل‌های امنیتی مانند seccomp و AppArmor برای محدود کردن syscalls استفاده می‌کنند. | کانتینرها باید پروفایل‌های seccomp و AppArmor برای امنیت بیشتر داشته باشند. | `docker inspect` |

## مورد تست #۹: بررسی لاگ‌های داکر برای مسائل امنیتی

هدف: شناسایی رویدادهای امنیتی بالقوه با بررسی لاگ‌های داکر.

| مرحله تست | توضیحات | نتیجه مورد انتظار | ابزارها |
| --- | --- | --- | --- |
| بررسی لاگ‌های داکر برای اقدامات ناموفق | بررسی لاگ‌های داکر برای فعالیت‌های مشکوک یا اقدامات ناموفق (مانند دسترسی غیرمجاز). | نباید رویدادهای غیرمنتظره یا غیرمجاز در لاگ‌ها وجود داشته باشد. | `docker logs <container_id>` |
| نظارت بر رویدادهای امنیتی در زمان اجرا | فعال کردن ابزارهای نظارت بر امنیت در زمان اجرا مانند Falco برای نظارت بر رفتارهای مشکوک. | باید برای هرگونه رویداد مشکوک یا غیرمنتظره هشدار ایجاد شود. | `Falco`, `Sysdig` |

## مورد تست #۱۰: موارد تست HackTricks

**شمارش رجیستری داکر**:
    **کشف**: استفاده از ابزارهایی مانند `nmap` برای شناسایی پورت‌های باز، مانند پورت پیش‌فرض رجیستری داکر `5000`. برای مثال: تست دسترسی به نقاط پایانی مانند `/v2/_catalog` برای بررسی مخازن تصویر.
        
        
        nmap -p5000 <target>

        
  **احراز هویت**: بررسی اینکه آیا احراز هویت برای دسترسی به رجیستری لازم است یا خیر با ارسال درخواست curl:

        
        curl -k https://<registry_IP>:5000/v2/_catalog

        
**افزایش امتیاز / خروج از کانتینر**:
    **بررسی Socket داکر**: بررسی اینکه آیا Socket داکر (`/var/run/docker.sock`) درون کانتینر متصل شده است که می‌تواند به خروج منجر شود اگر نادرست پیکربندی شده باشد. جستجوی socket درون کانتینر: در صورت یافتن، می‌توانید با دیمون داکر میزبان ارتباط برقرار کرده و به طور بالقوه از کانتینر خارج شوید:
        

        find / -name docker.sock

        

        docker run -it -v /:/host/ ubuntu:18.04 chroot /host/ bash

        
**افزایش قابلیت‌های کانتینر**:
    بررسی قابلیت‌های خطرناک مانند `CAP_SYS_ADMIN`، `CAP_NET_RAW` یا `CAP_SYS_PTRACE`. این‌ها می‌توانند به افزایش امتیاز درون کانتینر کمک کنند. می‌توانید این قابلیت‌ها را با استفاده از: اگر وجود داشته باشند، این قابلیت‌ها می‌توانند راهی برای خروج از کانتینر فراهم کنند.
        

        capsh --print

        
**کانتینرهای با دسترسی بالا**:
    اگر کانتینر با پرچم `privileged` یا قابلیت‌های اضافی (مانند `cap-add=ALL`) اجرا شود، تست کنید که آیا می‌توانید به فضای نام میزبان بروید:
        

        nsenter --target 1 --mount --uts --ipc --net --pid -- bash

        
**آسیب‌پذیری‌های کانتینر**:
    استفاده از ابزارهایی مانند `grype` برای اسکن آسیب‌پذیری‌های شناخته شده (CVEs) در تصویر کانتینر:
        

        grype <image>

        

## جمع‌بندی:

داکر یک ابزار بسیار قدرتمند برای توسعه و اجرای نرم‌افزارهاست، اما مانند هر ابزار دیگری باید با دقت و آگاهی از جوانب امنیتی استفاده شود. با رعایت نکات امنیتی و بررسی دوره‌ای آسیب‌پذیری‌ها، می‌توان از این پلتفرم به بهترین شکل و با امنیت بالا استفاده کرد.
</div>
